{% load i18n %}
<!-- Sub-form to specify calculation of this construction variable for all search elements -->
<tr id="research_calc_{{forloop.counter}}" class="hidden form-row inline" loop="{{vardef_number}}">
  <td colspan="4">
    <div class="panel panel-default">
      <p>Specify how variable <code>{{vardef_this.name.value}}</code> should be calculated for each search element</p>
      <table>
        <thead><tr><th>#</th><th>Name</th><th>Type</th><th>Value</th></tr></thead>
        <tbody>
        {% for cvar_formset in vardef_this.cvar_formset_list %}
          {{cvar_formset.management_form}}
            <tr class="form-row cvar-item">
              <td class="hidden">
                {% for cvar_form in cvar_formset %}
                  <div>{{cvar_form.id}}</div>
                {% endfor %}
              </td>
              <td valign="top">{{forloop.counter}}</td>
              <td valign="top">{{cvar_formset.construction.name}}</td>
              <td valign="top" class="cvar-type">
                {% for cvar_form in cvar_formset %}
                  <div>{{cvar_form.type}}</div>
                {% endfor %}
              </td>
              <td valign="top" class="cvar-val-exp">
                {% for cvar_form in cvar_formset %}
                  <div>
                  <!-- option 0: fixed value -->
                  <span class="cvar-value">{{cvar_form.svalue}}</span>
                  <!-- option 1: function/expression -->
                  <span class="cvar-expression">
                    <span class="cvar-fundef">
                      {{cvar_form.functiondef}}
                    </span>
                    <span id="cvar-functionid" class="hidden"><input id="id_cvar-function-__id__-id" type="hidden" value="" /></span>
                      
                    <!-- old method: [research_spec_] Test method: [research_specform_] -->
                    <!-- OLD: class="btn btn-xs btn-default cvar-specify" -->
                    <a class="btn btn-xs btn-default ajaxform" role="button" 
                       instanceid="{{cvar_form.instance.id}}"
                       ajaxurl="{% url 'get_spec_el' %}"
                       openid="research_spec_{{vardef_number}}_{{forloop.parentloop.counter}}" >
                      {% if cvar_form.function_id %}
                      {% trans 'edit' %}
                      {% else %}
                      {% trans 'create' %}
                      {% endif %}
                    </a>
                    <a class="cvar-summary">{% trans 'summary' %}</a>
                    ...
                  </span>
                  <!-- option 2: global variable -->
                  <span class="cvar-gvar">
                    {{cvar_form.gvar}}
                  </span>
                  <div class="cvar-expression-summary hidden"></div>
                  </div>
                {% endfor %}
              </td>
            </tr>
            <!-- Include room for the specification element builder -->
            {% include "seeker/specbuilder.html" %}
        {% endfor %}
        </tbody>
      </table>
    </div>
  </td>
</tr>
