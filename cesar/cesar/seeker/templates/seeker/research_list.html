{% extends "layout.html" %}
{% load i18n %}

{% block breadcrumbs %}
  <div class="breadcrumbs">
      <a href="{% url 'home' %}">Home</a>
      &rsaquo; Search
  </div>
{% endblock %}

{% block content %}

  <div class="container body-content">

    {% if authenticated %}
      <!-- Provide searchable columns -->
      <div >
        <form name="researchsearch" id="researchsearch" action="" method="get"  
                  onsubmit="return do_search('#id_submit_button', 'research', 'simple');" >
          <!-- EK: A sort-order specification is in a hidden form field, which is filled by JS:do_sort_column() -->
          <div class="hidden">
            <input name='sortOrder' class='form-control' value='name' >
            <input id="submit_type" name='submit_type' class='form-control' value='simple'>
          </div>
        </form>
      </div>

      {% if combi_list %}
      <div class="row">
        <div class="col-md-6">
          <h3>Research project overview</h3>
        </div>
        <div class="col-md-6" align="right">
          <h3><a title="upload a research project" 
             class="btn btn-success btn-xs" 
             targetid="import_main"
             onclick="ru.cesar.seeker.toggle_click(this);">
            <span class="glyphicon glyphicon-upload" aria-hidden="true"></span>
          </a></h3>
        </div>
      </div>

      <!-- Allow adding a project -->
      <div id="import_main" class="row hidden container">
        <form action="{% url 'import_file' %}" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <!-- Room for the filename to appear -->
          <div class="col-md-6 form-group" id="import_info"
               targetid="project_data_import"
               targeturl="{% url 'import_file' %}">
            <div class="input-group">
              <span>Specify the JSON file that contains the CESAR research project</span>
              <span class="input-group-btn">
                <span class="btn btn-default btn-xs btn-file">
                  Browse...
                  <input id="id_file_source" name="file_source" required="" type="file" oninput="ru.cesar.seeker.import_data('#import_info');" />
                </span>
                <!-- <input type="text" class="form-control" readonly />-->
              </span>
            </div>
            
          </div>
          <!-- Progress of upload indicator -->
          <div class="col-md-6">
            <progress class="hidden" style="width:100%;" id="import_progress" value="0" min="0" max="100"></progress>
          </div>
        </form>

        <!-- Import information -->
        <div id="project_data_import" class="project-part hidden"></div>
      </div>

      <!-- Room for errors -->
      <div id="research_err" class="row"></div>

      <!-- Hierarchical list of projects -->
      {% if resgroups and resgroups|length > 0 %}
        <table class="func-view">
          <thead>
            <tr>
              <th colspan="{{max_depth|add:"2"}}">
                <span class="func-name">Search groups</span>
                <span class="func-link pull-right">
                  <a class="btn btn-xs btn-default func-plus" role="button" title="view all"
                     onclick="ru.cesar.seeker.funchead_click(this, 'func-inline');">+</a>
                </span>
              </th>
            </tr>
          </thead>
          <tbody>
          {% for grp in resgroups %}
            <tr class="{% if grp.depth > 1 %}hidden{% endif %}" nodeid="{{grp.nodeid}}" childof="{{grp.childof}}">
              {% if grp.depth > 1 %}
                <td class="arg-pre" colspan="{{grp.depth}}" style="min-width: {{grp.minwidth}}px;"></td>
              {% endif %}
              {% if grp.prj %}
                <!-- Continue an existing group -->
                <td class="arg-plus" style="min-width: 20px;" 
                    onclick="crpstudio.htable.plus_click(this, 'func-inline');"></td>
                <td class="arg-text" colspan="{{grp.remainder}}">
                  <span class="arg-line">
                    <code>{{grp.prj.targetType}}</code>
                  </span>
                  <span class="arg-summary">{{grp.prj.name}}</span>
                </td>
              {% else %}
                <!-- Start a new group at level [depth] -->
                <td class="arg-plus" style="min-width: 20px;" 
                    onclick="crpstudio.htable.plus_click(this, 'func-inline');">+</td>
                <td class="arg-text" colspan="{{grp.remainder|add:"2"}}">
                  <span class="arg-line">
                    <code>{{grp.group}}</code>
                  </span>
                </td>
              {% endif %}
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% endif %}

      <!-- The actual list of projects -->
      <div class="row">
        <div class="col-md-12">
        <!-- The contents as a table -->
        <table class="table table-hover research-list">
          <thead>
            <tr>
              <th class="hidden">id</th>
              <!-- <th>Owner</th><th>Type</th><th>Name</th><th>Saved</th><th>Purpose</th> -->
              {% for hd in order_heads %}
              <th class="sortable" scope="col">
                <div class="text">
                  {% if hd.order == "" %}{{hd.name}}
                  {% else %}
                  <a href=?{{hd.order}}>{{hd.name}}</a>
                  {% endif %}
                </div>
              </th>
              {% endfor %}
              <th style="text-align: center;">Action</th>
            </tr>
          </thead>
          <tbody>
          {% for item in combi_list %}
            <tr class="research-item">
              <td class="hidden">{{item.project.id}}</td>
              <td><span class="research-item-user">{{item.project.username}}</span></td>
              <td title="{{item.project.get_targetType_display}}"><span class="research-item-type">{{item.project.get_targetType_display|slice:":4"}}</span></td>
              <td><span class="research-item-name">{{item.project.name}}</span></td>
              <td><span class="research-item-saved tdnowrap">{% if item.project.saved %}{{item.project.saved|date:"j/b/o G:i" }}{% else %}-{% endif %}</span></td>
              <td title="{{item.project.purpose}}" style="width:100%"><span class="research-item-purpose">{{item.project.purpose|truncatechars:85}}</span></td>
              <td class="tdnowrap">
                <!--<div class="part-buttons">-->
                  <form>
                    {% csrf_token %}
                    <span class="research-item-name ">
                    {% if item.may_write %}
                      <a type="button" title="open" class="btn btn-success btn-xs" href="{% url 'seeker_edit' object_id=item.project.id %}">
                        <span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>
                      </a>
                    {% endif %}
                    </span>
                    {% if item.may_read %}
                      <span class="research-item-copy">
                        <a title="copy" class="btn btn-default btn-xs" 
                           url="{{item.project.get_copy_url}}" 
                           success="{% url 'seeker_list' %}"
                           onclick="ru.cesar.seeker.process_item(this);">
                          <span class="glyphicon glyphicon-export" aria-hidden="true"></span>
                        </a>
                        <a title="download as JSON" class="btn btn-default btn-xs" 
                           ajaxurl="{% url 'search_json' object_id=item.project.id %}"
                           downloadtype="json"
                           onclick="ru.cesar.seeker.post_download(this);">
                          <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span>
                        </a>
                      </span>
                    {% endif %}
                    <span class="research-item-del ">
                    {% if item.may_delete %}
                      <a title="delete" class="btn btn-warning btn-xs" onclick="ru.cesar.seeker.toggle_del(this);">
                        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                      </a>
                    {% endif %}
                    </span>
                  </form>
                <!-- </div> -->
                <div class="part-process hidden"><span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span></div>
              </td>
            </tr>
            <!-- Provide a form row for deletion -->
            <tr class="part-del hidden">
              <td></td>
              <td colspan="3">Are you sure you want to delete the research project named <code>{{item.project.name}}</code>? Note: all associated results will also be deleted</td>
              <td class="tdnowrap">
                <div class="part-del">
                  <form action="{{item.project.get_delete_url}}" method="post">
                    {% csrf_token %}
                      <a class="btn btn-info btn-xs" onclick="ru.cesar.seeker.toggle_del(this);">cancel</a>
                      <a class="btn btn-danger btn-xs" 
                         url="{{item.project.get_delete_url}}" 
                         success="{% url 'seeker_list' %}"
                         onclick="ru.cesar.seeker.process_item(this);">delete</a>
                  </form>
                </div>
                <div class="part-process hidden"><span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span></div>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        </div>
      </div>
      {% else %}
        <p>{% trans "No research projects are available" %}.</p>
      {% endif %}
    {% else %}
    <div class="explanation">
      <p>Dear user, you are <b>not</b> logged in.</p>
      <p>Unfortunately this means that you will not be able to see any of the searches created by the users of Cesar.</p>
      <p>Should you want to work with Cesar, then here are your options:
        <ul>
          <li><a class="btn btn-info btn-xs" href="{% url 'login' %}">Login</a> - if you already have an account</li> 
          <li><a class="btn btn-warning btn-xs" href="{% url 'signup' %}">Sign up</a> - if you don't have an account yet</li>
        </ul>
      </p>
    </div>
    {% endif %}

  </div>


{% endblock content %}
